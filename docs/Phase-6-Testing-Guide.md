# Phase 6: Read Receipts - í…ŒìŠ¤íŠ¸ ê°€ì´ë“œ

## ì„œë²„ ì‹œì‘

### Backend (Spring Boot)

```bash
cd backend
./gradlew bootRun
```

ì„œë²„ê°€ ì‹œì‘ë˜ë©´:
- WebSocket: `ws://localhost:8080/ws`
- REST API: `http://localhost:8080/api`

### Frontend (Nuxt 3)

```bash
cd frontend
npm run dev
```

ë¸Œë¼ìš°ì €ì—ì„œ ì ‘ì†:
- http://localhost:3000

## í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

### ì‹œë‚˜ë¦¬ì˜¤ 1: ê¸°ë³¸ ì½ìŒ í‘œì‹œ (ì‹¤ì‹œê°„)

**ëª©ì **: ìƒˆ ë©”ì‹œì§€ê°€ ì½í˜”ì„ ë•Œ ì‹¤ì‹œê°„ìœ¼ë¡œ ì²´í¬ë§ˆí¬ê°€ ë³€ê²½ë˜ëŠ”ì§€ í™•ì¸

**ë‹¨ê³„**:

1. **ì‚¬ìš©ì A (ë¸Œë¼ìš°ì € 1)**
   - http://localhost:3000/login ì ‘ì†
   - Username: `Alice` ì…ë ¥ í›„ ë¡œê·¸ì¸
   - ì±„íŒ…ë°© `general` ì…ì¥

2. **ì‚¬ìš©ì B (ë¸Œë¼ìš°ì € 2 - ì‹œí¬ë¦¿ ëª¨ë“œ)**
   - http://localhost:3000/login ì ‘ì†
   - Username: `Bob` ì…ë ¥ í›„ ë¡œê·¸ì¸
   - ì±„íŒ…ë°© `general` ì…ì¥

3. **Aliceê°€ ë©”ì‹œì§€ ì „ì†¡**
   - "Hello Bob!" ì…ë ¥ í›„ ì „ì†¡
   - âœ… **í™•ì¸**: Alice í™”ë©´ì— íšŒìƒ‰ ë‹¨ì¼ ì²´í¬ë§ˆí¬ (âœ“) í‘œì‹œ

4. **Bobì´ ë©”ì‹œì§€ í™•ì¸**
   - Bobì˜ í™”ë©´ì— "Hello Bob!" ë©”ì‹œì§€ê°€ ë³´ì„
   - (ìë™ìœ¼ë¡œ ì½ìŒ ì²˜ë¦¬ë¨)
   - âœ… **í™•ì¸**: Alice í™”ë©´ì—ì„œ íšŒìƒ‰ âœ“ â†’ íŒŒë€ìƒ‰ âœ“âœ“ ë¡œ ë³€ê²½ (ì•½ 1ì´ˆ í›„)

**ì˜ˆìƒ ê²°ê³¼**:
- Alice ë©”ì‹œì§€ íƒ€ì„ìŠ¤íƒ¬í”„ ì˜†ì— íŒŒë€ìƒ‰ ì´ì¤‘ ì²´í¬ë§ˆí¬ (âœ“âœ“) í‘œì‹œ
- readCount = 1

---

### ì‹œë‚˜ë¦¬ì˜¤ 2: í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ í›„ ì½ìŒ ìƒíƒœ ìœ ì§€

**ëª©ì **: ë©”ì‹œì§€ íˆìŠ¤í† ë¦¬ ë¡œë“œ ì‹œ ì½ìŒ ìƒíƒœê°€ ì˜¬ë°”ë¥´ê²Œ í‘œì‹œë˜ëŠ”ì§€ í™•ì¸

**ë‹¨ê³„**:

1. **ì‹œë‚˜ë¦¬ì˜¤ 1 ì™„ë£Œ í›„**
   - Aliceì™€ Bob ëª¨ë‘ ì±„íŒ…ë°©ì— ìˆëŠ” ìƒíƒœ
   - Aliceì˜ "Hello Bob!" ë©”ì‹œì§€ì— âœ“âœ“ í‘œì‹œë¨

2. **Alice í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ (F5)**
   - ë¸Œë¼ìš°ì € ìƒˆë¡œê³ ì¹¨

3. **í™•ì¸ ì‚¬í•­**
   - âœ… ë©”ì‹œì§€ íˆìŠ¤í† ë¦¬ ë¡œë“œë¨
   - âœ… "Hello Bob!" ë©”ì‹œì§€ì— ì—¬ì „íˆ íŒŒë€ìƒ‰ âœ“âœ“ í‘œì‹œ
   - âœ… readCount = 1 ìœ ì§€

**ì˜ˆìƒ ê²°ê³¼**:
- í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ í›„ì—ë„ ì½ìŒ ìƒíƒœê°€ ìœ ì§€ë¨
- Backendì—ì„œ readBy, readCount ë°ì´í„° í¬í•¨í•˜ì—¬ ë°˜í™˜

---

### ì‹œë‚˜ë¦¬ì˜¤ 3: ë‹¤ì¤‘ ì‚¬ìš©ì ì½ìŒ

**ëª©ì **: ì—¬ëŸ¬ ì‚¬ìš©ìê°€ ë©”ì‹œì§€ë¥¼ ì½ì—ˆì„ ë•Œ readCountê°€ ì •í™•í•œì§€ í™•ì¸

**ë‹¨ê³„**:

1. **ì‚¬ìš©ì A (Alice)**
   - ì±„íŒ…ë°© `general` ì…ì¥
   - "Meeting at 3pm" ë©”ì‹œì§€ ì „ì†¡
   - âœ“ í‘œì‹œ í™•ì¸

2. **ì‚¬ìš©ì B (Bob)**
   - ì±„íŒ…ë°© `general` ì…ì¥
   - Aliceì˜ ë©”ì‹œì§€ ìë™ ì½ìŒ
   - Alice í™”ë©´: âœ“ â†’ âœ“âœ“ (readCount: 1)

3. **ì‚¬ìš©ì C (Charlie - ë¸Œë¼ìš°ì € 3)**
   - http://localhost:3000/login ì ‘ì†
   - Username: `Charlie` ì…ë ¥
   - ì±„íŒ…ë°© `general` ì…ì¥
   - Aliceì˜ ë©”ì‹œì§€ ìë™ ì½ìŒ

4. **í™•ì¸ ì‚¬í•­**
   - âœ… Alice í™”ë©´: âœ“âœ“ ìœ ì§€ (readCount: 2)
   - âœ… Bob, Charlie í™”ë©´: ë‹¤ë¥¸ ì‚¬ëŒì˜ ë©”ì‹œì§€ì´ë¯€ë¡œ ì²´í¬ë§ˆí¬ ì—†ìŒ

**ì˜ˆìƒ ê²°ê³¼**:
- readCountê°€ ì •í™•í•˜ê²Œ ì¦ê°€ (1 â†’ 2)
- ë³¸ì¸ ë©”ì‹œì§€ì—ë§Œ ì²´í¬ë§ˆí¬ í‘œì‹œ

---

### ì‹œë‚˜ë¦¬ì˜¤ 4: ë³¸ì¸ ë©”ì‹œì§€ëŠ” ì½ìŒ ì²˜ë¦¬ ì•ˆ ë¨

**ëª©ì **: ë³¸ì¸ì´ ë³´ë‚¸ ë©”ì‹œì§€ëŠ” ì½ìŒ ì²˜ë¦¬ë˜ì§€ ì•ŠëŠ”ì§€ í™•ì¸

**ë‹¨ê³„**:

1. **Aliceê°€ ë©”ì‹œì§€ ì „ì†¡**
   - "Test message" ì „ì†¡
   - âœ… Alice í™”ë©´ì— âœ“ í‘œì‹œ

2. **Aliceê°€ ìŠ¤í¬ë¡¤**
   - ì±„íŒ… ì°½ ì•„ë˜ë¡œ ìŠ¤í¬ë¡¤
   - ìì‹ ì˜ ë©”ì‹œì§€ê°€ í™”ë©´ì— ë³´ì„

3. **í™•ì¸ ì‚¬í•­**
   - âœ… âœ“ ìƒíƒœ ìœ ì§€ (âœ“âœ“ë¡œ ë³€ê²½ë˜ì§€ ì•ŠìŒ)
   - âœ… ë³¸ì¸ ë©”ì‹œì§€ëŠ” ì½ìŒ ì²˜ë¦¬ ì•ˆ ë¨

**ì˜ˆìƒ ê²°ê³¼**:
- ë³¸ì¸ ë©”ì‹œì§€ëŠ” ìë™ ì½ìŒ ì²˜ë¦¬ë˜ì§€ ì•ŠìŒ
- ë‹¤ë¥¸ ì‚¬ìš©ìê°€ ì½ì–´ì•¼ë§Œ âœ“âœ“ë¡œ ë³€ê²½

---

### ì‹œë‚˜ë¦¬ì˜¤ 5: ì—¬ëŸ¬ ë©”ì‹œì§€ ì¼ê´„ ì½ìŒ

**ëª©ì **: ì‚¬ìš©ìê°€ ì±„íŒ…ë°©ì— ì…ì¥í–ˆì„ ë•Œ ëª¨ë“  ì•ˆ ì½ì€ ë©”ì‹œì§€ê°€ ì½ìŒ ì²˜ë¦¬ë˜ëŠ”ì§€ í™•ì¸

**ë‹¨ê³„**:

1. **Aliceê°€ ë©”ì‹œì§€ 3ê°œ ì „ì†¡**
   - "Message 1"
   - "Message 2"
   - "Message 3"
   - ëª¨ë‘ âœ“ ìƒíƒœ

2. **Bobì´ ì±„íŒ…ë°© ì…ì¥**
   - 3ê°œ ë©”ì‹œì§€ ëª¨ë‘ í™”ë©´ì— ë³´ì„
   - (ë§ˆì§€ë§‰ ë©”ì‹œì§€ë§Œ ì½ìŒ ì²˜ë¦¬ë¨ - í˜„ì¬ êµ¬í˜„)

3. **í™•ì¸ ì‚¬í•­**
   - âœ… Alice í™”ë©´: "Message 3"ì´ âœ“âœ“ë¡œ ë³€ê²½
   - âœ… Message 1, 2ëŠ” âœ“ ìœ ì§€ (ê°œì„  ì—¬ì§€)

**ì˜ˆìƒ ê²°ê³¼**:
- í˜„ì¬ëŠ” ë§ˆì§€ë§‰ ë©”ì‹œì§€ë§Œ ì½ìŒ ì²˜ë¦¬
- (í–¥í›„ ê°œì„ : Intersection Observerë¡œ ë³´ì´ëŠ” ëª¨ë“  ë©”ì‹œì§€ ì²˜ë¦¬)

---

## ë””ë²„ê¹… ì²´í¬ë¦¬ìŠ¤íŠ¸

### Backend ë¡œê·¸ í™•ì¸

```bash
# Backend ì½˜ì†”ì—ì„œ í™•ì¸í•  ë¡œê·¸
[ChatWebSocketController] Read receipt: user Bob read message xxx in room general
[ReadReceiptService] Saved read status - messageId: xxx, userId: Bob
[ReadReceiptService] Updated Redis cache - key: room:general:lastRead:Bob
[ChatWebSocketController] Read receipt broadcast: messageId=xxx, userId=Bob
```

### Frontend ì½˜ì†” í™•ì¸

```javascript
// ë¸Œë¼ìš°ì € ì½˜ì†”ì—ì„œ í™•ì¸
[useReadReceipts] Sending read receipt: { messageId, userId, roomId, timestamp }
[useReadReceipts] Received read receipt: { messageId, userId, timestamp }
[useReadReceipts] Updated read status for message: xxx readBy: ["Bob"]
[ChatWindow] Message read count updated: { messageId, readCount: 1 }
```

### ë„¤íŠ¸ì›Œí¬ íƒ­ í™•ì¸

1. **ë©”ì‹œì§€ íˆìŠ¤í† ë¦¬ ë¡œë“œ**
   - Request: `GET /api/messages/history/general?limit=50`
   - Response: ê° ë©”ì‹œì§€ì— `readBy`, `readCount` í¬í•¨ í™•ì¸

2. **WebSocket í”„ë ˆì„**
   - SEND: `/app/chat.read` í”„ë ˆì„ í™•ì¸
   - RECEIVE: `/topic/room/general` - ReadReceipt ì´ë²¤íŠ¸ í™•ì¸

---

## ë¬¸ì œ í•´ê²°

### ì²´í¬ë§ˆí¬ê°€ í‘œì‹œë˜ì§€ ì•ŠìŒ

**ì›ì¸ 1: Backendê°€ readBy ë°˜í™˜ ì•ˆ í•¨**
```bash
# MessageHistoryController ë¡œê·¸ í™•ì¸
log.debug("Retrieved {} messages for room: {} with read status", ...)
```

**í•´ê²°**: Backend ì¬ì‹œì‘ í›„ ë¹Œë“œ í™•ì¸

**ì›ì¸ 2: Frontend ì´ˆê¸°í™” ì•ˆ ë¨**
```javascript
// ë¸Œë¼ìš°ì € ì½˜ì†”ì—ì„œ í™•ì¸
console.log(messages.value[0].readBy)  // [] ë˜ëŠ” ["userId"]
console.log(messages.value[0].readCount)  // 0 ë˜ëŠ” 1
```

**í•´ê²°**: í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨

### ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ì•ˆ ë¨

**ì›ì¸: WebSocket ì—°ê²° ë¬¸ì œ**
```javascript
// ë¸Œë¼ìš°ì € ì½˜ì†”ì—ì„œ í™•ì¸
[STOMP] Connected
[ChatRoom] Joined room: general
```

**í•´ê²°**: WebSocket ì—°ê²° ìƒíƒœ í™•ì¸

### readCountê°€ ì¦ê°€í•˜ì§€ ì•ŠìŒ

**ì›ì¸: ì¤‘ë³µ ì½ìŒ ë°©ì§€ ë¡œì§**
```java
// Backend ë¡œê·¸ í™•ì¸
[ReadReceipt] Duplicate read event (cached), skipping
```

**í•´ê²°**: ì •ìƒ ë™ì‘ - ê°™ì€ ì‚¬ìš©ìê°€ ì—¬ëŸ¬ ë²ˆ ì½ì–´ë„ 1íšŒë§Œ ì¹´ìš´íŠ¸

---

## ì„±ëŠ¥ í…ŒìŠ¤íŠ¸

### ë©”ì‹œì§€ íˆìŠ¤í† ë¦¬ ë¡œë“œ ì‹œê°„

```bash
# Backend ì½˜ì†”ì—ì„œ ì¸¡ì •
2024-01-22 10:30:00.123 DEBUG [...] Retrieved 50 messages for room: general with read status
```

**ëª©í‘œ**: 50ê°œ ë©”ì‹œì§€ ë¡œë“œ < 200ms

### ì½ìŒ ì´ë²¤íŠ¸ ì§€ì—° ì‹œê°„

**ì¸¡ì •**:
1. Bobì´ ë©”ì‹œì§€ ì½ìŒ
2. Alice í™”ë©´ì—ì„œ âœ“âœ“ í‘œì‹œë  ë•Œê¹Œì§€ ì‹œê°„ ì¸¡ì •

**ëª©í‘œ**: < 1.5ì´ˆ (ë””ë°”ìš´ì‹± 1ì´ˆ + ë„¤íŠ¸ì›Œí¬ 0.5ì´ˆ)

---

## ë‹¤ìŒ ë‹¨ê³„ ê°œì„  ì‚¬í•­

### Phase 6.1: Intersection Observer ê°œì„ 

**í˜„ì¬**: ë§ˆì§€ë§‰ ë©”ì‹œì§€ë§Œ ì½ìŒ ì²˜ë¦¬
**ê°œì„ **: í™”ë©´ì— ë³´ì´ëŠ” ëª¨ë“  ë©”ì‹œì§€ ì½ìŒ ì²˜ë¦¬

```typescript
// useReadReceiptsì— Intersection Observer ì¶”ê°€
const observer = new IntersectionObserver((entries) => {
  entries.forEach((entry) => {
    if (entry.isIntersecting) {
      const messageId = entry.target.getAttribute('data-message-id')
      markAsRead(messageId)
    }
  })
})
```

### Phase 6.2: ì½ì€ ì‚¬ëŒ ëª©ë¡ í‘œì‹œ

**UI ê°œì„ **:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Alice                              â”‚
â”‚  Meeting at 3pm?                    â”‚
â”‚  Read by: Bob, Charlie     10:30 âœ“âœ“ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Phase 6.3: ì½ì§€ ì•Šì€ ë©”ì‹œì§€ ìˆ˜

**ì±„íŒ…ë°© ëª©ë¡ì— ë°°ì§€ í‘œì‹œ**:
```
ğŸ“± general (3) â† ì½ì§€ ì•Šì€ ë©”ì‹œì§€ 3ê°œ
ğŸ“± random
```

---

## ì™„ë£Œ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] ì‹œë‚˜ë¦¬ì˜¤ 1: ì‹¤ì‹œê°„ ì½ìŒ í‘œì‹œ âœ“âœ“
- [ ] ì‹œë‚˜ë¦¬ì˜¤ 2: í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ í›„ ìœ ì§€
- [ ] ì‹œë‚˜ë¦¬ì˜¤ 3: ë‹¤ì¤‘ ì‚¬ìš©ì readCount
- [ ] ì‹œë‚˜ë¦¬ì˜¤ 4: ë³¸ì¸ ë©”ì‹œì§€ ì œì™¸
- [ ] ì‹œë‚˜ë¦¬ì˜¤ 5: ì¼ê´„ ì½ìŒ ì²˜ë¦¬
- [ ] Backend ë¡œê·¸ í™•ì¸
- [ ] Frontend ì½˜ì†” í™•ì¸
- [ ] ë„¤íŠ¸ì›Œí¬ ìš”ì²­/ì‘ë‹µ í™•ì¸
- [ ] ì„±ëŠ¥ ì¸¡ì • (ë¡œë“œ ì‹œê°„ < 200ms)

í…ŒìŠ¤íŠ¸ ì™„ë£Œ í›„ Phase 6 êµ¬í˜„ ì™„ë£Œ!
